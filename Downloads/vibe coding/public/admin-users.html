<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Aircraft Defect Detection</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap-icons.css">
    <!-- Liquid Background CSS -->
    <link rel="stylesheet" href="css/liquid-background.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            padding-top: 20px;
            z-index: 1000;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        .brand-section {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .brand-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0;
        }

        .brand-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .page-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            max-width: 400px;
        }

        .table-actions {
            display: flex;
            gap: 5px;
        }

        .badge-role {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .status-active {
            color: #059669;
        }

        .status-inactive {
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand-section">
            <h1 class="brand-title">Admin Panel</h1>
            <p class="brand-subtitle">Aircraft Defect Detection</p>
        </div>
        <nav class="nav flex-column">
            <a class="nav-link" href="admin-dashboard.html">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a class="nav-link active" href="admin-users.html">
                <i class="bi bi-people"></i> Users
            </a>
            <a class="nav-link" href="admin-models.html">
                <i class="bi bi-cpu"></i> Models
            </a>
            <a class="nav-link" href="admin-monitoring.html">
                <i class="bi bi-graph-up"></i> Monitoring
            </a>
            <a class="nav-link" href="#" id="logoutBtn">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">User Management</h1>
                <p class="text-muted mb-0">Manage user accounts and permissions</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal"
                onclick="openCreateModal()">
                <i class="bi bi-plus-circle"></i> Create User
            </button>
        </div>

        <div class="content-card">
            <!-- Search and Filter -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group search-bar">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput"
                            placeholder="Search by username or email...">
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <select class="form-select d-inline-block w-auto" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    <select class="form-select d-inline-block w-auto ms-2" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <nav aria-label="User pagination">
                <ul class="pagination justify-content-center" id="pagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3" id="passwordGroup">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                            <small class="text-muted">Min 8 characters, uppercase, lowercase, digit, special
                                char</small>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Role</label>
                            <select class="form-select" id="role" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3" id="statusGroup" style="display: none;">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="alert alert-danger" id="modalError" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Liquid Background JS -->
    <script src="js/liquid-background.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/axios.min.js"></script>
    <!-- Auth Module -->
    <script src="js/auth.js"></script>
    <script>
        // Check authentication
        if (!Auth.requireAuth(true)) {
            // Will redirect to login
        }
    </script>
    <script>
        let currentPage = 1;
        let currentSearch = '';
        let currentRoleFilter = '';
        let currentStatusFilter = '';
        let isEditMode = false;

        // Check authentication
        function checkAuth() {
            const user = Auth.getUser();
            if (!user) return false;
            const userRole = user.role;

            if (!token || userRole !== 'admin') {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Fetch users
        async function fetchUsers(page = 1) {
            try {
                const params = {
                    page,
                    limit: 10
                };

                if (currentSearch) params.search = currentSearch;
                if (currentRoleFilter) params.role = currentRoleFilter;
                if (currentStatusFilter) params.status = currentStatusFilter;

                const response = await axios.get('/api/admin/users', {
                    headers: Auth.getAuthHeaders(),
                    params
                });

                displayUsers(response.data.users);
                displayPagination(response.data.page, response.data.pages);
                currentPage = page;

            } catch (error) {
                console.error('Error fetching users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr><td colspan="6" class="text-center text-danger">
                        Failed to load users. ${error.response?.data?.error?.message || ''}
                    </td></tr>
                `;
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>
                        <span class="badge badge-role ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">
                            ${user.role.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <i class="bi bi-circle-fill ${user.status === 'active' ? 'status-active' : 'status-inactive'}"></i>
                        ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditModal('${user._id}')" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-${user.status === 'active' ? 'warning' : 'success'}" 
                                    onclick="toggleUserStatus('${user._id}', '${user.status}')" 
                                    title="${user.status === 'active' ? 'Deactivate' : 'Activate'}">
                                <i class="bi bi-${user.status === 'active' ? 'pause' : 'play'}-circle"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Display pagination
        function displayPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="fetchUsers(${currentPage - 1}); return false;">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="fetchUsers(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="fetchUsers(${currentPage + 1}); return false;">Next</a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // Open create modal
        function openCreateModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Create User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('password').required = true;
            document.getElementById('statusGroup').style.display = 'none';
            document.getElementById('modalError').style.display = 'none';
        }

        // Open edit modal
        async function openEditModal(userId) {
            isEditMode = true;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = userId;
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('password').required = false;
            document.getElementById('statusGroup').style.display = 'block';
            document.getElementById('modalError').style.display = 'none';

            try {
                const response = await axios.get(`/api/admin/users`, {
                    headers: Auth.getAuthHeaders()
                });

                const user = response.data.users.find(u => u._id === userId);
                if (user) {
                    document.getElementById('username').value = user.username;
                    document.getElementById('username').disabled = true;
                    document.getElementById('email').value = user.email;
                    document.getElementById('role').value = user.role;
                    document.getElementById('status').value = user.status;
                }

                const modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();

            } catch (error) {
                console.error('Error fetching user:', error);
                alert('Failed to load user data');
            }
        }

        // Save user (create or update)
        document.getElementById('saveUserBtn').addEventListener('click', async () => {
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const status = document.getElementById('status').value;
            const modalError = document.getElementById('modalError');

            modalError.style.display = 'none';

            try {
                if (isEditMode) {
                    // Update user
                    await axios.put(`/api/admin/users/${userId}`, {
                        email,
                        role,
                        status
                    }, {
                        headers: Auth.getAuthHeaders()
                    });
                } else {
                    // Create user
                    await axios.post('/api/admin/users', {
                        username,
                        email,
                        password,
                        role
                    }, {
                        headers: Auth.getAuthHeaders()
                    });
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                modal.hide();
                fetchUsers(currentPage);

            } catch (error) {
                console.error('Error saving user:', error);
                modalError.textContent = error.response?.data?.error?.message || 'Failed to save user';
                modalError.style.display = 'block';
            }
        });

        // Toggle user status
        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';

            if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this user?`)) {
                return;
            }

            try {
                await axios.put(`/api/admin/users/${userId}`, {
                    status: newStatus
                }, {
                    headers: Auth.getAuthHeaders()
                });

                fetchUsers(currentPage);

            } catch (error) {
                console.error('Error updating user status:', error);
                alert('Failed to update user status');
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            fetchUsers(1);
        });

        // Filter functionality
        document.getElementById('roleFilter').addEventListener('change', (e) => {
            currentRoleFilter = e.target.value;
            fetchUsers(1);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentStatusFilter = e.target.value;
            fetchUsers(1);
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();

            try {
                await Auth.logout();
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.clear();
            window.location.href = 'login.html';
        });

        // Re-enable username field when modal is hidden
        document.getElementById('userModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('username').disabled = false;
        });

        // Initialize
        if (checkAuth()) {
            fetchUsers(1);
        }
    </script>
</body>

</html>